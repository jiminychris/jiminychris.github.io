<html>
  <head>
    <title>Spelling Bee Training</title>
    <style>
      #textbox {display: block;}
      #progress {font-weight: bold;}
      .incorrect {
          font-weight: bold;
          color: #8B0000;
      }
      .formfield * {
          vertical-align: top;
      }
    </style>
    <meta name="referrer" content="no-referrer">
  </head>
  <body>
    <h1>Spelling Bee Training</h1>
    <div id="attract">
      Choose word list.
      <div id="lists">
      </div>
      <input id="upload" type="button" value="New word listâ€¦">
    </div>
    <div id="play" hidden>
      <input id="textbox" autocorrect="off" spellcheck="false">
      <audio id="audio"></audio>
      <div>
        <input id="submit" type="button" hidden>
        <input id="repeat" type="button" value="Repeat">
        <input id="define" type="button" value="Define">
        <input id="restart" type="button" value="Restart">
        <input id="refine" type="button" value="Restart with incorrect words" hidden>
        <input id="quit" type="button" value="Quit">
      </div>
      <p id="progress"></p>
      <ul id="scoreboard">
      </ul>
    </div>
    <dialog id="dialog">
      <form method="dialog">
        <p class="formfield">
          <label>Name
            <input id="dialog_name">
          </label>
        </p>
        <p class="formfield">
          <label>Words
            <textarea id="dialog_words" rows="32" cols="52" placeholder="enter&#10;each&#10;word&#10;on&#10;its&#10;own&#10;line"></textarea>
          </label>
        </p>
        <div>
          <button value="cancel">Cancel</button>
          <button id="save" value="default">Save</button>
        </div>
      </form>
    </dialog>
    <script>
      let wordLists = [
        {
          name: "Archdiocesan Spelling Bee Word List",
          words:
          [
            "Archdiocesan",
            "Deuteronomy",
            "Ecclesiastes",
            "Ephesians",
            "Exodus",
            "Ezekiel",
            "Fahrenheit",
            "Japanese",
            "Lamentations",
            "Leviticus",
            "Malachi",
            "Mediterranean",
            "Mesozoic",
            "Micah",
            "Nehemiah",
            "Pentecost",
            "Philippians",
            "Philistines",
            "Sirach",
            "Thessalonians",
            "Zechariah",
            "Zephaniah",
            "abbreviation",
            "abhorred",
            "absolution",
            "absorbency",
            "absurdity",
            "acceleration",
            "accelerator",
            "accessible",
            "accolade",
            "accomplice",
            "accomplishment",
            "accreditation",
            "accrual",
            "acknowledging",
            "acquittal",
            "acupuncture",
            "adjacent",
            "administrative",
            "adolescence",
            "aerodynamic",
            "aeronautics",
            "aggregate",
            "aghast",
            "algebraically",
            "algorithm",
            "alleviate",
            "altercation",
            "altocumulus",
            "amicable",
            "amnesia",
            "amortization",
            "anaphylaxis",
            "ancillary",
            "anesthesia",
            "anniversary",
            "annotation",
            "anonymous",
            "antagonism",
            "antiphon",
            "antiquity",
            "apartheid",
            "appendicitis",
            "apropos",
            "aristocrat",
            "arraignment",
            "assassinate",
            "auspices",
            "baccalaureate",
            "backgammon",
            "ballistic",
            "baroque",
            "beautifully",
            "belligerent",
            "beneficiary",
            "bereavement",
            "bicentennial",
            "blasphemous",
            "blasphemously",
            "boisterous",
            "bouillon",
            "boutonniere",
            "buccaneer",
            "bureaucrat",
            "calisthenics",
            "camouflage",
            "cantankerous",
            "cappuccino",
            "carbohydrate",
            "carcinogen",
            "catastrophe",
            "catechumen",
            "cauterize",
            "champagne",
            "chasuble",
            "chauvinism",
            "chronological",
            "chrysanthemum",
            "claustrophobia",
            "coincidental",
            "collateral",
            "collegial",
            "colossal",
            "commensurate",
            "commitment",
            "compassion",
            "condescending",
            "connoisseur",
            "conscientious",
            "conservationist",
            "consignment",
            "consternation",
            "consubstantial",
            "crescendo",
            "curriculum",
            "cybernetics",
            "debonair",
            "deceive",
            "decentralization",
            "deciduous",
            "deficiency",
            "delicatessen",
            "delirious",
            "denominator",
            "dexterity",
            "dialogue",
            "dialysis",
            "differentiate",
            "dilapidated",
            "discombobulated",
            "discourse",
            "disposition",
            "diversify",
            "divinity",
            "doctrine",
            "documentary",
            "documentation",
            "dominance",
            "dystrophy",
            "eccentric",
            "eclectic",
            "ecumenism",
            "efficiency",
            "egocentric",
            "eloquence",
            "embezzlement",
            "emeritus",
            "empirical",
            "enlightenment",
            "entomologist",
            "entourage",
            "entrepreneur",
            "enunciate",
            "enzyme",
            "equilateral",
            "equilibrium",
            "espionage",
            "etiquette",
            "eucalyptus",
            "euphemism",
            "euthanasia",
            "evangelization",
            "exhilarated",
            "extemporaneous",
            "extenuating",
            "extraneous",
            "extraordinary",
            "extraterrestrial",
            "extravagant",
            "facetiously",
            "facilitate",
            "fatigue",
            "favoritism",
            "feasible",
            "fictitious",
            "fidelity",
            "flagrant",
            "flamboyant",
            "fluorescent",
            "fortissimo",
            "fortitude",
            "frankincense",
            "frivolous",
            "furlough",
            "genealogy",
            "geocentric",
            "geographical",
            "geriatrics",
            "glandular",
            "globalization",
            "grievance",
            "gubernatorial",
            "gullible",
            "hacienda",
            "hallucination",
            "handkerchief",
            "harmonious",
            "haughtily",
            "hemorrhaging",
            "heterogeneous",
            "hieroglyphic",
            "hieroglyphics",
            "hippopotamus",
            "humiliate",
            "idealistically",
            "idiosyncratic",
            "illumination",
            "immaculate",
            "imperative",
            "impetus",
            "improvise",
            "incandescence",
            "incognito",
            "inconsequential",
            "incorrigible",
            "indigenous",
            "inflammatory",
            "inheritance",
            "inoculate",
            "insecticide",
            "insinuate",
            "inspiration",
            "insufficient",
            "intellectualize",
            "interference",
            "interplanetary",
            "interpretation",
            "irrevocable",
            "isolation",
            "isopropyl",
            "isotope",
            "isthmus",
            "itinerary",
            "jaundiced",
            "judgmental",
            "jurisdiction",
            "jurisprudence",
            "kaleidoscope",
            "knowledgeable",
            "labyrinth",
            "lackadaisical",
            "lethargic",
            "liberalism",
            "liberation",
            "lieutenant",
            "logarithm",
            "longitudinal",
            "luminous",
            "maintenance",
            "maraschino",
            "massacre",
            "mathematician",
            "matriarch",
            "matrimony",
            "mausoleum",
            "mechanical",
            "mediocrity",
            "memorabilia",
            "meringue",
            "metacarpal",
            "metaphysics",
            "mezzanine",
            "microbial",
            "mischievous",
            "misnomer",
            "modesty",
            "mozzarella",
            "myrrh",
            "mystical",
            "mythology",
            "nautilus",
            "necessarily",
            "nepotism",
            "neurotic",
            "nimbostratus",
            "notoriety",
            "nuisance",
            "obedience",
            "obstetrician",
            "ophthalmologist",
            "opinionated",
            "ordination",
            "osmosis",
            "ostentatious",
            "outrageous",
            "overconfidence",
            "oxymoron",
            "pachyderm",
            "paleontology",
            "panoramic",
            "paramedic",
            "paranoia",
            "parliament",
            "pasteurize",
            "pedestrian",
            "penitentiary",
            "pericardium",
            "peritonitis",
            "perpendicularly",
            "perseverance",
            "pharmaceutical",
            "philanthropist",
            "philharmonic",
            "plagiarize",
            "platypus",
            "plausible",
            "pneumatic",
            "polychromatic",
            "potpourri",
            "precocious",
            "preposterous",
            "prerogative",
            "procrastination",
            "proem",
            "prolific",
            "prophetic",
            "prospectus",
            "prudence",
            "puppeteer",
            "pyrotechnics",
            "quadrilateral",
            "quandary",
            "quarantine",
            "quarrelsome",
            "questionnaire",
            "quiche",
            "quintessence",
            "quivering",
            "rambunctious",
            "recession",
            "reciprocal",
            "recognizance",
            "reconciliation",
            "referendum",
            "reimbursable",
            "rendezvous",
            "repertoire",
            "repudiate",
            "reservoir",
            "resolute",
            "responsorial",
            "restitution",
            "resurrection",
            "rheumatism",
            "romanticism",
            "salvation",
            "sanctifying",
            "sanguine",
            "scenario",
            "scrumptious",
            "sensationalism",
            "sergeant",
            "simultaneous",
            "staccato",
            "stymied",
            "subservient",
            "superficial",
            "susceptibility",
            "symmetrical",
            "synonymous",
            "synoptic",
            "synthetic",
            "temperamental",
            "temperance",
            "temptation",
            "tenacious",
            "theological",
            "thesaurus",
            "throughout",
            "timorous",
            "totalitarian",
            "translucent",
            "transmissible",
            "turpitude",
            "turquoise",
            "tyrannical",
            "tyranny",
            "ulcerate",
            "ultimately",
            "unceremoniously",
            "unconscious",
            "unforgettable",
            "unilateral",
            "university",
            "vacillate",
            "vehement",
            "vendetta",
            "vengeance",
            "ventriloquist",
            "vindicate",
            "vindictive",
            "visibility",
            "vitality",
            "vulcanize",
            "wearisome",
            "wharf",
            "whimsical",
            "whippoorwill",
            "wretchedness",
            "xenophobia",
            "zephyr",
          ]
        }
      ];

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }
      (function() {
        audio = document.getElementById("audio");
        dialog = document.getElementById("dialog");
        lists = document.getElementById("lists");
        attract = document.getElementById("attract");
        play = document.getElementById("play");
        buttonUpload = document.getElementById("upload");
        textbox = document.getElementById("textbox");
        submit = document.getElementById("submit");
        repeat = document.getElementById("repeat");
        define = document.getElementById("define");
        refine = document.getElementById("refine");
        restart = document.getElementById("restart");
        buttonQuit = document.getElementById("quit");
        scoreboard = document.getElementById("scoreboard");
        progress = document.getElementById("progress");
        dialog_name = document.getElementById("dialog_name");
        dialog_words = document.getElementById("dialog_words");

        localWordLists = JSON.parse(localStorage.getItem("lists") ?? "[]");

        function updateScoreboard(value, clazz) {
          var li = document.createElement("li");
          if (clazz !== undefined) li.classList.add(clazz);
          li.append(document.createTextNode(value));
          scoreboard.prepend(li);
        }
      
        function chooseList(l) {
          wordList = l;
          words = l.words;
          attract.hidden = true;
          play.hidden = false;
          initialize();
        }

        function deleteList(index) {
          const wordList = localWordLists[index];
          if(confirm(`Are you sure you want to delete the list "${wordList.name}"?`)) {
            localWordLists.splice(index, 1);
            localStorage.setItem("lists", JSON.stringify(localWordLists));
            refreshWordLists();
          }
        }

        function parseWords(x) {
          return x.split("\n").filter(w => w.trim().length > 0);
        }

        function editList(index) {
          const wordList = localWordLists[index];

          function handleDialogEditClose() {
            if (dialog.returnValue !== "cancel") {
              wordList.name = dialog_name.value;
              wordList.words = parseWords(dialog_words.value);
              localStorage.setItem("lists", JSON.stringify(localWordLists));
              refreshWordLists();
            }
            dialog_name.value = "";
            dialog_words.value = "";
            dialog.removeEventListener("close", handleDialogEditClose);
          }

          dialog_name.value = wordList.name;
          dialog_words.value = wordList.words.join("\n");
          dialog.addEventListener("close", handleDialogEditClose);
          dialog.showModal();
        }

        function quit() {
          play.hidden = true;
          attract.hidden = false;
        }

        function createButton(value, action) {
          const button = document.createElement("input");
          button.type = "button"
          button.value = value;
          button.onclick = action;
          return button;
        }

        function createSelectButton(wordList) {
          return createButton("Select", () => chooseList(wordList));
        }

        function createWordListEntry(wordList, buttons) {
          const block = document.createElement("div");
          const listName = document.createTextNode(wordList.name);
          buttons.forEach(button => block.appendChild(button));
          block.appendChild(listName);
          lists.appendChild(block);
          return block;
        }

        function refreshWordLists() {
          lists.innerHTML = "";
          wordLists.forEach(wordList => createWordListEntry(wordList, [createSelectButton(wordList)]));
          localWordLists.forEach((wordList, index) => createWordListEntry(wordList, [
            createSelectButton(wordList),
            createButton("Edit", () => editList(index)),
            createButton("Delete", () => deleteList(index)),
          ]));
        }
        refreshWordLists();

        textbox.onkeydown = function(event) {
          if (event.keyCode == 13) submit.click();
        };

        var score, index, r, spellings, word, randomizer, incorrectWords, words, wordList;

        function say(phrase) {
          window.speechSynthesis.cancel();
          audio.pause();
          audio.currentTime = 0;
          textbox.focus();
          audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=en&q=${encodeURIComponent(phrase)}`;
          audio.play().catch(() => window.speechSynthesis.speak(new SpeechSynthesisUtterance(phrase)));
        }

        function sayWord() {
          say(word);
        }

        function defineWord() {
          let definitionText;
          textbox.focus();
          const xhr = new XMLHttpRequest();
          xhr.open('GET', `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`, true);
          xhr.onload = e => {
            if(xhr.readyState === 4) {
              if(xhr.status === 200) {
                var definitions = [];
                const parsed = JSON.parse(xhr.responseText);
                parsed[0]["meanings"].forEach(meaning => {
                  meaning["definitions"].forEach(definition => {
                    definitions.push(definition["definition"])
                  });
                });
                if (definitions.length > 1) {
                  definitions.length = Math.min(definitions.length, 2);
                  definitions = definitions.map((d, i) => `${i+1}. ${d}`);
                }
                definitionText = definitions.join(" ");
              } else if(xhr.status === 404) {
                definitionText = "No definition found.";
              } else {
                definitionText = "Error loading definition.";
                console.error(xhr.statusText);
              }
            }
            say(definitionText);
          };
          xhr.onerror = e => {
            say("Error loading definition.");
            console.error(xhr.statusText);
          };
          xhr.send(null);
        }

        function advance() {
          guess = textbox.value
          if (guess !== "") {
            textbox.value = "";
            if (spellings.some(spelling => guess.toLowerCase() === spelling.toLowerCase())) {
              ++score;
            } else {
              incorrectWords.push(word);
              updateScoreboard(`Incorrect! ${word} (You said "${guess}")`, "incorrect");
            }
            index++;
            if (index < words.length) {
              populate();
            } else {
              updateScoreboard(`Game over. You got ${score} correct.`);
              if (score !== words.length) refine.hidden = false;
              submit.onclick = null;
              repeat.hidden = true;
              define.hidden = true;
          }
          } else {
            say(word);
          }
        }

        function populate() {
          r = randomizer[index];
          spellings = words[r].split("|");
          word = spellings[0];
          progress.innerText = `Progress: ${index + 1} / ${words.length}`;
          say(word);
        }

        function initialize() {
          scoreboard.innerHTML = "";
          index = score = 0;
          incorrectWords = [];
          randomizer = Array.from(Array(words.length).keys());
          shuffleArray(randomizer);
          submit.onclick = advance;
          repeat.hidden = false;
          define.hidden = false;
          refine.hidden = true;
          populate();
          textbox.focus();
        }

        function reset() {
          words = wordList.words;
          initialize();
        }

        function refinedReset() {
          words = incorrectWords;
          initialize();
        }

        function upload() {
          function handleDialogAddClose() {
            if (dialog.returnValue !== "cancel") {
              localWordLists.push({
                name: dialog_name.value,
                words: parseWords(dialog_words.value),
              });
              localStorage.setItem("lists", JSON.stringify(localWordLists));
              refreshWordLists();
            }
            dialog_name.value = "";
            dialog_words.value = "";
            dialog.removeEventListener("close", handleDialogAddClose);
          }

          dialog.addEventListener("close", handleDialogAddClose);
          dialog.showModal();
        }
                        
        restart.onclick = reset;
        refine.onclick = refinedReset;
        repeat.onclick = sayWord;
        define.onclick = defineWord;
        buttonUpload.onclick = upload;
        buttonQuit.onclick = quit;
      })();
    </script>
  </body>
</html>
